# 题目四

## 实验要求

* 4、通过调试器监控计算器程序的运行，每当运行结果为666时，就改为999。

* 提示：找到运行结果在内存中保存的地址。监控 “=” 按键消息等。

## 实验环境

* win7

* windbg 32位

* calc.exe 32位

## 实验思路

* 实时性的问题。什么时间改？要显示之前立刻改掉。因此不能再直接在内存中搜索，而且“666”也不是很特殊。必须从代码方向考虑。

* 直接改代码。找到显示666的代码，很有可能在做控件的时候，监视到textout函数被调用了，如果参数是666，则改成999。涉及到hook。

* 这是一个系统的api，找到它的地址并改掉。改textout函数的指针。函数在哪里？API调用一定和导入导出密切相关。动态链接库里面，在导出表里找到，下一个断点，去看是不是真的会被调用，若是，则大概率是它起作用。

* windbg的功能可能会用到。指针的找法，除了导出表，也在IAT（导入表）中。导出表只在运行的时候用一次。

* 除了改指针，还可以改代码。textout函数（有一个xyz），先分配内存空间，将xyz写过去（自己的代码），覆盖为jump。然后在自己的代码：参数指针的定位和修改，xyz，再jump回去。改计算器、笔记本、外挂都是这样写。

* 先分析一下目标。控件：SetwindowText函数（其实也是调用了Textout函数）。非控件，Textout。与字符串相关的都有两个函数：A，W。输出一个方块。屏幕取词：检测Textout函数，两个参数：字符串和位置。理论上能知道屏幕全部位置的显示全部字符串。

* 看导入表，一个程序有没有调用api：①直接在源代码中用到的通常调用，肯定会出现在导入表当中。②采用getproaddress，获取地址，通过指针调用。不会出现在导入表，但是可以监测该函数，然后分析参数。

* 64位操作系统既可以运行64位也可以32位。SysWOW64里面是32位的。system32里面是64位。dumpbin /headers calc.exe。去看machine属性。

* 下断点，看输出。 bp SetWindowTextW。会报错。could not be resolved不能解析（API的名字和它对应的地址）。pdb（program database）文件是在编译的时候产生的。部分源码与程序对应关系。build过程中默认下是有这个文件的。下断点等必须要有pdb来维持。

* windbg 菜单sumbol file path。搜索：symbol path for Windows debugger。https://msdl.microsoft.com/download/symbols.的那一行  .sympath是一个命令，不用粘进去。reload 勾一下。懒惰模式，reload 没有用就没有加载。

* 再次 bp SetWindowTextW。

* .reload /f（强制） /i

* 然后把SetWindowTextW和textput全部下断点。当命中，程序终止，去看参数。

## 实验过程

* 启动32位的计算器。一般在```C:\Windows\SysWOW64```目录下。

* 启动软件```windbg```，从```file```中```Open Execuatble```添加exe文件calc.exe。

* 创建脚本。4.txt。放入```C:\Windbg Scripts\4.txt```中。
```bash
#新定义一个别名为name。将 poi（esp+0x8）处的 unicode字符串取出
as /mu ${/v:name} poi(esp+0x8)  

#进行字符串比较 如果name和666相同 就改为 999 否则输出name
.if($scmp(@"${name}","666")==0){ezu poi(esp+0x8) "999";}.else{.echo ${name};}

#程序继续运行
g
```

* 回到windbg中，执行命令，设置SetWindowTextW处的断点。
```
bp SetWindowTextW "$<C:\\Windbg\ Scripts\\4.txt"
```

* 再次执行g。继续运行

## 实验结果

![](录屏.gif)

##实验问题集锦

* win7系统安装不上增强功能
点击虚拟机的安装增强功能没有反应。其实已经加载完成。在file explorer里可以找到。点击安装即可。

* windbg安装32位还是64位应与要分析的程序保持一致。
















